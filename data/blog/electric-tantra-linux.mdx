---
title: the Electric Tantra Linux
date: "2020-07-15"
summary: instead of giving interested parties a repo of files they may browse through, I have opted to show them what my environment is like by giving them a live version of it to use by bundling it into a ISO.
tags: [Linux]
draft: true
---

I have long wanted to create my own Linux distribution, my reasons being that I want a liveusb tailored to my preferences that I can quickly install my preferred system onto whatever hardware I happen to need to reinstall on at any given moment (such is the result of experiment I suppose) and to a greater extent because screenshots or gifs do not really do justice to exactly what I have welded together out the semi-functional AwesomeWM in Lua since I started using it a year and a half ago. I can show an interested party my files but being that my configuration is well over 50 files, in a few languages, its hard to imagine the exact functionality taking it all in at a glance. So I set up an Arch Linux variant to demonstrate my configuration in an environment that is reproducable and produces the behavior I enjoy (or tinker with) locally. 

## The Problem of Replication

Part of getting my AwesomeWM configuration to its present stage has been a lot of examining the code written by others because Lua doesn't have the number of tutorials and guides of more popular languages I use like Javascript. Especailly in the context of configuring the only window manager to use it, in which case I have found three guids, an old wiki and a new, generated-from-comments-in-source-code replacement wiki. The former two options are for an older version of Awesome and are no longer applicable, while the latter is predictably awful and hard to comprehend. Thus the only way I have been able to piece together how to use Lua in this context is by examining **lots** of other people's configurations. 

As with any dive into random code, especially code meant to configure Linux programs, the author has generally written the code for their personal use and optimized it accordingly. This is not something anyone can begrudge the author of, even though it may be preferred for everyone's sake were more people inclined to follow the age old advise we have all heard until our ears bled about the need to comment what is going on in our code. However, this tendency to set up configurations specific to your context means that in order to even demonstrate your configuration locally, a whole bunch of shims and adjustments need to happen first, otherwise things like malformed scripts to check processor usage will run up the CPU's heat to emergency shut off levels (happened to me once) or some critical aspect of the configuration won't work, may not even spit out an error notification and the user may just think your configuration sucks and ignore it or write you off. 

Being unwilling to allow my work product such an ignoble fate, I have come up with two primary solutions to mitigate this with my own configuration. The first is due to my dotfiles having become too large and spilling into multiple repositories, such that I have tried to make my configurations wholly modular, so you could ignore the rest of my dotfiles outright and just download my Awesome configuration and get it to work, as all the required scripts and external libraries of Lua functions are included there within (specifically I keep them all in the external subdirectory of that configuration). This means with only the prerequisite step of insuring the development feature of Awesome is installed (with maim, dunst xcape and rofi also for various functionality), you'll be able to appreciate how nice it is to have the application menu come up when you press the Windows key and won't need to track down obscure Lua libraries to remove the awful looking default wallpaper awesome uses to encourage users to customize their systems (can't image that hideous thing is meant for much else). 

Being a human myself, I understand that even that extra set of installation steps may be too much for many people, so I have come up with the second solution to this connodrum, packaging the whole set up within an ISO file that has everything already on it and distributing that. Which is the best solution for this issue and enables me to solve the need to mitigate the Arch Installation headaches that were at one time a common issue I had to contend with as I can also package my installation script therewithin while providing other nice programs to have when computer issues arise such as GParted & Clonezilla(disk management applications). As is so often the case, the best solution also requires the most challenging path to pursue, but that's fine by me as I am not one of the 'lazy coders' Microsoft was at one time prioritizing hiringand I am fine with that, were it not for work I would be very bored after all. 

## Building the ISO

In order to build the iso, I have used the program `archiso` which provides the terminal command `mkarchiso` that can be used to create an archlinux liveusb from a standardized profile provided by the `archiso` application `/usr/share/archiso/configs`. Two profiles are present at that location, `baseline` and `releng`, of which I have used the latter as the former is a little more barebones and I was not making any barebones arch variant.   

### The Anatomy of the Profile
The structure of the profile presents the user with the following repositories

| Directory or File | What's Its Purpose |
|-------------------|--------------------|
| airootfs | This is where are the files that will be in the output ISO are kept |
| efiboot | For boot entries |
| packages.x86_64 | A list of packages to install during the ISO build |
| profiledef.sh | Metadata relating to the ISO such as its name, your name, etc | 
| pacman.conf | pacman configurations to use for build |
| syslinux | More configuration of the boot process, specifically the menu and associated options. |

### First Pitfall: AUR Packages 
No small part of my configuration depends on packages external to the typical Arch repositories and so I would need to use `yay` or at least `git clone` to download these packages during a normal dotfiles installation procedure, but that is not quite the goal. Instead I did a month or two worth of research in my free time, with subsequent hair pulling and immense frustration experimenting with, different options to host my own repository. Let me spare you that pain and just cut to the case: use Github directly (with the right url you can use it in pacman.conf). 

There is a lot involved in the implementation of this feature, which I may make a blog post about in the future, but I will not bore you with that at present. Instead, it is suffice to say that I got it to work and included a line in the pacman.conf at the root of the releng directory I copied from the project directory that allows it to pull in packages from AUR I have packaged for this purpose. This includes an AUR helper in case users want to add to their ISO or explore the offerings of the AUR, the development branch of AwesomeWM that enables the fancy functionality of my config and a whole lot of packages I may not even truly need but like having or think I should have. 

### Second Pitfall: Submodules and Symlinks
The second, less frustrating aspect of the Electric Tantra Linux experience was determining how to get my configurations on board the ISO. There is a directory that is copied directly to the user's home directory, which is `airootfs/etc/skel` which seems easy enough so I hard copied everything into its right place but this made maintanence a challenge if any of the 6+ repos of mine I utilize changed in any way. While this is normally something I handle using `myrepos` to pull in changes to these pre-configured locations, within the ISO was more of an obstacle. So I finally just sat down and forced myself to master the fickle functionality of `git submodules` that actually make sense in this case (unlike my dotfiles, where they make everything harder with their detached HEADS ). 

Using all the same repos that are part of the constellation that are my dotfiles' many composite repos, I was even able to easily roll in the submodules used in my `zsh` configuration without *too much* fuss. The command to include that repository, in case you were wondering, is:

``git submodule update add https://github.com/Thomashighbaugh/zsh airootfs/etc/skel/.zsh && ln -svf airootfs/etc/skel/.zsh/env airootfs/etc/skel/.zshenv && ln -svf airootfs/etc/skel/.zsh/rc airootfs/etc/skel/.zshrc``
